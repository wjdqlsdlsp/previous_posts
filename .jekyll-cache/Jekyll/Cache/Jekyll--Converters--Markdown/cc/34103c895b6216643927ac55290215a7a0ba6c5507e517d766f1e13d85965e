I"Ü$<blockquote>
  <p>ë³¸ í¬ìŠ¤íŠ¸ëŠ”, Terraform Up &amp; Running í…Œë¼í¼ - OREILLYë¥¼ ì°¸ê³ í–ˆìŠµë‹ˆë‹¤.</p>
</blockquote>

<p>í˜¼ìì„œ ì‘ì—…í•˜ê¸°ì—ëŠ” localì—ì„œ terraform stateë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ì§€ë§Œ,</p>

<p>íŒ€ ë‹¨ìœ„ ì‘ì—…ì„ ìœ„í•´ì„œëŠ” ì›ê²© ì €ì¥ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

<p>ì´ë¥¼ ìœ„í•´ì„œ ê°€ì¥ ì í•©í•œ ê²ƒì€ ìŠ¤í† ë¦¬ì§€ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

<p>ëŒ€í‘œì ìœ¼ë¡œ AWSì—ëŠ” S3ê°€ ìˆëŠ”ë° ì´ì™€ ê°™ì´ DynamoDBë¥¼ ì´ìš©í•˜ë©´ ì ì ˆí•©ë‹ˆë‹¤.</p>

<hr />

<h3 id="s3--dynamodb">S3 &amp; DynamoDB</h3>

<p>S3ëŠ” AWSì—ì„œ ì œê³µí•˜ëŠ” ìŠ¤í† ë¦¬ì§€ ì„œë¹„ìŠ¤ì´ë©°, DynamoDBëŠ” AWSì—ì„œ ì œê³µí•˜ëŠ” NoSQLì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

<p>ì›ê²©ì €ì¥ì†Œë¥¼ ìœ„í•´ì„œ ì´ë¥¼ êµ¬ì¶•í•´ì•¼í•˜ëŠ”ë°, ì´ë¥¼ ìœ„í•´ ë‹¤ë¥¸ í´ë”ì—ì„œ í…Œë¼í¼ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>provider <span class="s2">"aws"</span> <span class="o">{</span>
  region <span class="o">=</span> <span class="s2">"ap-northeast-2"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ë¨¼ì € ë™ì¼í•˜ê²Œ providerë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># s3</span>
resource <span class="s2">"aws_s3_bucket"</span> <span class="s2">"terraform_state"</span> <span class="o">{</span>
  bucket <span class="o">=</span> <span class="s2">"jeongbin-terraform-bucket"</span>

  lifecycle <span class="o">{</span>
    prevent_destroy <span class="o">=</span> <span class="nb">true</span>
  <span class="o">}</span>
<span class="o">}</span>

resource <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"versioning_example"</span> <span class="o">{</span>
  bucket <span class="o">=</span> aws_s3_bucket.terraform_state.id
  versioning_configuration <span class="o">{</span>
    status <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="o">}</span>
<span class="o">}</span>

resource <span class="s2">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="s2">"example"</span> <span class="o">{</span>
  bucket <span class="o">=</span> aws_s3_bucket.terraform_state.id
  rule <span class="o">{</span>
    apply_server_side_encryption_by_default <span class="o">{</span>
      sse_algorithm <span class="o">=</span> <span class="s2">"AES256"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œëŠ” s3ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</p>

<p>lifecycleì˜ ê²½ìš° prevent_destroyë¥¼ ì„¤ì •í–ˆëŠ”ë°, ì´ëŠ” ì•ˆì— ê°ì²´ê°€ ìˆì„ ë•Œ ì‚­ì œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì˜µì…˜ì…ë‹ˆë‹¤.</p>

<p>ë²„ì „ ê´€ë¦¬ë¥¼ ìœ„í•´ì„œ versioningì„ enableë¡œ ì„¤ì •í–ˆìœ¼ë©°, encrytionë„ ì„¤ì •í•´ì„œ ë³´ì•ˆì„ ë†’í˜”ìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># DynamoDB</span>
resource <span class="s2">"aws_dynamodb_table"</span> <span class="s2">"terraform_locks"</span> <span class="o">{</span>
  name <span class="o">=</span> <span class="s2">"terraform-up-and-running-locks"</span>
  billing_mode <span class="o">=</span> <span class="s2">"PAY_PER_REQUEST"</span>
  hash_key <span class="o">=</span> <span class="s2">"LockID"</span>

  attribute <span class="o">{</span>
    name <span class="o">=</span> <span class="s2">"LockID"</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>DynamoDBì˜ ê²½ìš° ìœ„ì™€ ê°™ì´ ì •ì˜í–ˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ hash_keyë¥¼ â€œLockIDâ€ë¡œ ì„¤ì •í–ˆìŒì„ ì£¼ì˜í•˜ì„¸ìš”.</p>

<p>ì´ë ‡ê²Œ <code class="language-plaintext highlighter-rouge">terraform apply</code> ë¥¼ í†µí•´ S3ì™€ DynamoDBë¥¼ ìƒì„±í•˜ë©´ ì´ì œ ë‹¤ì‹œ ì‚¬ìš©í•˜ë˜ í…Œë¼í¼ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>

<hr />

<h3 id="backend-ì •ì˜">backend ì •ì˜</h3>

<p>ì´ì „ì˜ ì½”ë“œì—ì„œ, ì›ê²© ì €ì¥ì†Œë¥¼ ì—°ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë°±ì—”ë“œ ì •ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform <span class="o">{</span>
  backend <span class="s2">"s3"</span> <span class="o">{</span>
    bucket <span class="o">=</span> <span class="s2">"jeongbin-terraform-bucket"</span>
    key <span class="o">=</span> <span class="s2">"global/s3/terraform.tfstate"</span>
    region <span class="o">=</span> <span class="s2">"ap-northeast-2"</span>

    dynamodb_table <span class="o">=</span> <span class="s2">"terraform-up-and-running-locks"</span>
    encrypt <span class="o">=</span> <span class="nb">true</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ë°±ì—”ë“œ ì •ì˜ ê°™ì€ ê²½ìš° ì´ì „ì— ìƒì„±í•œ bucket nameê³¼ dynamodb tableì´ë¦„ì„ ì…ë ¥í•´ì£¼ë©´ ë©ë‹ˆë‹¤.</p>

<p>ì´ë ‡ê²Œ ì„¤ì •í•˜ê³  <code class="language-plaintext highlighter-rouge">terraform init</code> ë° <code class="language-plaintext highlighter-rouge">terraform apply</code> ë¥¼ í†µí•´ ìƒì„±í•©ë‹ˆë‹¤.</p>

<p>ì´ì „ê³¼ ë‹¤ë¥´ê²Œ, local í™˜ê²½ì— tfstate íŒŒì¼ì´ ì—†ëŠ”ë°, ì´ëŠ” s3ì— ì €ì¥ë˜ì–´ ìˆìŒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h3 id="hclíŒŒì¼">hclíŒŒì¼</h3>

<p>ë°±ì—”ë“œ íŒŒì¼ì—ì„œì˜ ë‹¨ì ì€, ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ì…ë‹ˆë‹¤.</p>

<p>ìœ„ì—ì„œ ë³´ë©´ ì§ì ‘ â€œstringâ€ì„ í†µí•´ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<p>ì´ëŸ¬í•œ ì ìœ¼ë¡œ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ ì‘ì„±í•´ì•¼ í•˜ëŠ” ë¶ˆí¸í•¨ì´ ìˆì„ ìˆ˜ ìˆëŠ”ë° ì´ë¥¼ ìœ„í•´ hcl íŒŒì¼ì„ ì •ì˜í•˜ëŠ” ê²ƒë„ ë°©ë²•ì…ë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># backend.hcl</span>
bucket <span class="o">=</span> <span class="s2">"jeongbin-terraform-bucket"</span>
region <span class="o">=</span> <span class="s2">"ap-northeast-2"</span>
dynamodb_table <span class="o">=</span> <span class="s2">"terraform-up-and-running-locks"</span>
encrypt <span class="o">=</span> <span class="nb">true</span>
</code></pre></div></div>

<p><br /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># backend.tf</span>
terraform <span class="o">{</span>
  backend <span class="s2">"s3"</span> <span class="o">{</span>
    key <span class="o">=</span> <span class="s2">"global/s3/terraform.tfstate"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ìœ„ì™€ ê°™ì´ hclíŒŒì¼ì„ ì •ì˜í•˜ë©´ tfíŒŒì¼ì€ í›¨ì”¬ ê°„ê²°í•´ì§‘ë‹ˆë‹¤.</p>

<p>ì´í›„ hclì˜ ë°ì´í„°ë¥¼ ì´ìš©í•œë‹¤ëŠ” ì˜ë¯¸ë¡œ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform init <span class="nt">-backend-config</span><span class="o">=</span>backend.hcl
</code></pre></div></div>

<p>ë¥¼ ì˜µì…˜ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h3 id="ê²©ë¦¬">ê²©ë¦¬</h3>

<p>í…Œë¼í¼ì—ëŠ” ì‘ì—…ê³µê°„ì„ ê²©ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì—¬ê¸°ì„œëŠ” worksapceë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.</p>

<p>ì¿ ë²„ë„¤í‹°ìŠ¤ ë“±ì—ì„œ namespaceë¥¼ ì‚¬ìš©í•´ ë³´ì…¨ë‹¤ë©´ ìµìˆ™í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform workspace show
</code></pre></div></div>

<p>ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ì„œ í˜„ì¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform workspace new example1
</code></pre></div></div>

<p>ìƒˆë¡œìš´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ new ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform apply
</code></pre></div></div>

<p>ì´í›„ terraform apply ì…ë ¥í•˜ë©´ ì´ì „ê³¼ ë‹¤ë¥´ê²Œ ìƒˆë¡œìš´ ìì›ì´ ìƒì„±ë©ë‹ˆë‹¤. (ë‹¨ terraform nameì´ ì•„ë‹Œ aws ë¦¬ì†ŒìŠ¤ nameì´ ê°™ì€ ê²½ìš° ì—ëŸ¬ê°€ ë‚  ìˆ˜ë„ ìˆìŒ)</p>

<p align="center"><img src="/images/post_img/terraform2.png" /></p>

<p>S3ë¥¼ í™•ì¸í•´ë³´ë©´ env:/ ë¼ëŠ” í´ë”ì— ìƒì„±í•œ tfstateê°€ ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform workspace <span class="k">select </span>default
</code></pre></div></div>

<p>ë‹¤ì‹œ ì›ë˜ ìƒíƒœë¡œ ëŒì•„ ì˜¤ê¸° ìœ„í•´ì„œëŠ” selectë¥¼ í†µí•´ ë³€ê²½í•´ì¤ë‹ˆë‹¤.</p>

<p>ì´ëŸ¬í•œ ê²©ë¦¬ëŠ”, ì™„ì „íˆ ë™ì¼í•œ ì¸í”„ë¼ë¥¼ ë°°í¬ë˜ì–´ ìˆëŠ” ì¸í”„ë¼ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  í…ŒìŠ¤íŠ¸í•˜ê¸°ì— ì í•©í•©ë‹ˆë‹¤.</p>

<hr />

<h3 id="3í•­-ì—°ì‚°ì">3í•­ ì—°ì‚°ì</h3>

<p>terraform ì—ì„œë„ 3í•­ ì—°ì‚°ìë¥¼ ì‚¬ìš© í•  ìˆ˜ ìˆëŠ”ë°</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource <span class="s2">"aws_instance"</span> <span class="s2">"ec2"</span> <span class="o">{</span>
  ami <span class="o">=</span> <span class="s2">"ami-0ea5eb4b05645aa8a"</span>
  instance_type <span class="o">=</span> terraform.workspace <span class="o">==</span> <span class="s2">"defaults"</span> ? <span class="s2">"t3.nano"</span>: <span class="s2">"t3.medium"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ìœ„ì™€ ê°™ì´, ì‘ì—… ê²©ë¦¬ í™˜ê²½ì— ë”°ë¼ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ì–‘ì„ ë³€ê²½í•˜ëŠ” ë“± ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

:ET