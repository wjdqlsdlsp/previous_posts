I"âC<p>ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë©´, Webì„ ìš´ì˜í•˜ëŠ” íŒŒë“œì™€ DBë¥¼ ìš´ì˜í•˜ëŠ” íŒŒë“œê°€ ì—°ê²°ë˜ì–´ì•¼ í•˜ëŠ” ìƒí™©ì´ ìƒê¹ë‹ˆë‹¤.</p>

<p>ë³´í†µ DBì˜ ê²½ìš° ê´€ë¦¬í˜• AWS RDSê°™ì€ ê´€ë¦¬í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì§ì ‘ íŒŒë“œë¥¼ ìš´ì˜í•˜ì—¬ ì—°ê²°í•˜ëŠ” ë°©ë²•ì„ ì •ë¦¬í•˜ê³ ì í•©ë‹ˆë‹¤.</p>

<p>í¬ê²Œ 2ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì—°ê²°ì„ ì‹œë„í•´ ë´¤ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>Sidecar íŒ¨í„´</li>
  <li>2ê°œì˜ Service</li>
</ul>

<p><br /></p>

<h3 id="sidecar-íŒ¨í„´">Sidecar íŒ¨í„´</h3>

<p>ê°€ì¥ ë¨¼ì € SidecaríŒ¨í„´ì…ë‹ˆë‹¤.</p>

<p>í•˜ë‚˜ì˜ íŒŒë“œ ì•ˆì— 2ê°œì˜ ì»¨í…Œì´ë„ˆ, ì¦‰ DBì™€ Web server ì»¨í…Œì´ë„ˆê°€ ê°™ì´ ì¡´ì¬í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.</p>

<p align="center"><img src="/images/post_img/k8s-sidecar.png" width="400px" /></p>

<p>ì´ë¥¼ í†µí•´ì„œ êµ¬í˜„í•˜ë©´ ê°™ì€ ë…¸ë“œì— í• ë‹¹ë˜ì–´ ê°™ì€ ipì£¼ì†Œë¥¼ ê°–ê²Œ ë˜ì–´ localhostë¥¼ ì´ìš©í•´ì„œ ì—°ê²°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” Sidecar íŒ¨í„´ì˜ ì—°ê²° ë°©ë²•ì…ë‹ˆë‹¤.</p>

<p>fastapi-containerì˜ env ë¥¼ ë³´ë©´, DB_HOSTê°€ localhostë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sidecar-svc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8000</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">sidecar</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
</code></pre></div></div>
<p><br /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sidecar-deployment</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">sidecar</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">sidecar</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">sidecar-pod</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">sidecar</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">fast:0.1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">fastapi-container</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8000</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">password'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_HOST</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">localhost'</span> <span class="c1"># localhostì‚¬ìš©</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mysql-db'</span>

      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:8.0.28</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-container</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">password'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mysql-db'</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒì€ êµ¬í˜„ì€ ê°€ëŠ¥í•˜ì§€ë§Œ, MSAêµ¬ì¡°ì—ì„œ scale up í•  ë•Œ ë¶ˆí¸í•¨ì„ ëŠë¼ê²Œ ë©ë‹ˆë‹¤.</p>

<p>í•˜ì§€ë§Œ ê°„ë‹¨í•œ ì›¹êµ¬ì¡°ì—ì„œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©ë  ë“¯ í•©ë‹ˆë‹¤.</p>

<p><br /></p>

<h3 id="ê°ê°-ë‹¤ë¥¸-serviceë¥¼-ì´ìš©í•œ-ì—°ê²°">ê°ê° ë‹¤ë¥¸ Serviceë¥¼ ì´ìš©í•œ ì—°ê²°</h3>

<p align="center"><img src="/images/post_img/k8s-svc-svc.png" width="400px" /></p>

<p>ë‹¤ìŒ êµ¬ì¡°ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¼ë¦¬ì˜ ì—°ê²°ì…ë‹ˆë‹¤.</p>

<p>ìœ„ì™€ ê°™ì€ ê²½ìš°ëŠ” ì„¤ì •í•œ DB service nameì„ í†µí•´ì„œ ì—°ê²°ì´ ê°€ëŠ¥í•œ êµ¬ì¡°ì…ë‹ˆë‹¤.</p>

<p>ê°ê° í•˜ë‚˜ì˜ Pod ì•ˆì— ê°ê°ì˜ containerë¥¼ ì„¤ì •í•˜ê³ , ì´ë¥¼ deployment ì™€ serviceë¡œ ë¬¶ìŠµë‹ˆë‹¤.</p>

<p>ì´í›„ DB service ì™€ Web serviceê°€ ì—°ê²°ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” ì‚¬ìš©í•œ ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤.</p>

<p>fastapi deploymentì˜ spec.template.spec.env ì˜ MYSQL_HOSTì™€</p>

<p>mysql serviceì˜ metadata.name ì´ ê°™ìŒì„ ì£¼ëª©í•˜ì„¸ìš”.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fastapi-svc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8000</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">fastapi</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-svc</span> <span class="c1"># Mysql service name</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>
<p><br /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastapi deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fastapi</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">fastapi</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">fastapi</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">fastapi</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">fastapi</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">fast:0.1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">fastapi</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8000</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">password'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_HOST</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mysql-svc'</span> <span class="c1"># Mysql service name</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mysql-db'</span>
<span class="nn">---</span>
<span class="c1"># DB deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-deployment</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:8.0.28</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-pod</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">password'</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mysql-db'</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="ports-nameì„-í†µí•´ì„œ-ì—°ê²°ì€-ì•ˆë˜ë‚˜ìš”">ports nameì„ í†µí•´ì„œ ì—°ê²°ì€ ì•ˆë˜ë‚˜ìš”?</h3>

<p>ì œê°€ í—·ê°ˆë ¸ë˜ ë‚´ìš© ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. Dockerì˜ ê²½ìš° docker-composeì—ì„œ networkë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ ë¸Œë¦¿ì§€ë¥¼ í†µí•´ì„œ ì—°ê²°í•˜ëŠ” ê²½ìš°ê°€ ìƒê° ë‚  ê²ƒì…ë‹ˆë‹¤.</p>

<p>ê·¸ë ‡ë‹¤ë©´ k8sì—ì„œ ports nameì„ ì„¤ì •í•˜ê³  ì´ë¥¼ í†µí•´ ì—°ê²° í•  ìˆ˜ ëŠ” ì—†ì„ ê¹Œìš”â€¦?</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># db container</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:8.0.28</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-container</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">password'</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mysql-db'</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">db-port</span> <span class="c1"># port name ì„¤ì •</span>
        <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>

<p><br /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-svc</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="s">db-port</span> <span class="c1"># port nameìœ¼ë¡œ ì„¤ì •</span>
</code></pre></div></div>

<p>ì œê°€ ì–»ì–´ë‚¸ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<p>portsì˜ nameì€ ë„¤íŠ¸ì›Œí¬ê°€ ì•„ë‹Œ portë¥¼ ë§µí•‘í•˜ê¸° ìœ„í•œ ë‚´ìš©ì¸ ë“¯í•©ë‹ˆë‹¤.</p>

<p>ìœ„ì™€ ê°™ì´, ì„¤ì •í•œ nameì„ í‰í•´ì„œ portë¥¼ ì„¤ì •í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<p><br /></p>

:ET