I"åË<h1 id="introduction-to-pyspark">Introduction to PySpark</h1>

<p><br /></p>

<h2 id="1-getting-to-know-pyspark">1. Getting to know PySpark</h2>

<h4 id="what-is-spark">What is Spark?</h4>

<p>SparkëŠ”, í´ëŸ¬ìŠ¤í„° ì»´í“¨íŒ…ì„ ìœ„í•œ í”Œë«í¼ì…ë‹ˆë‹¤.</p>

<p>Sparkë¥¼ ì‚¬ìš©í•˜ë©´, ì—¬ëŸ¬ ë…¸ë“œê°€ ìˆëŠ” í´ëŸ¬ìŠ¤í„°ì— ë°ì´í„°ì™€ ê³„ì‚°ì„ ë¶„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ( ê° ë…¸ë“œë¥¼ ì»´í“¨í„°ë¡œ ìƒê° )</p>

<p>ë°ì´í„°ë¥¼ ë¶„í• í•˜ë©´ ê° ë…¸ë“œê°€ ì†ŒëŸ‰ì˜ ë°ì´í„°ì—ì„œë§Œ ì‘ë™í•˜ê¸° ë•Œë¬¸ì— ë§¤ìš° í° ë°ì´í„° ì„¸íŠ¸ë¡œ ë” ì‰½ê²Œ ì‘ì—… í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ê° ë…¸ë“œëŠ”, ì „ì²´ ê³„ì‚°ì˜ ì¼ë¶€ë¥¼ ìˆ˜í–‰í•˜ë©°, ë°ì´í„° ì²˜ë¦¬ì™€ ê³„ì‚°ì´ í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œì—ì„œ ë³‘ë ¬ë¡œ ìˆ˜í–‰ ë©ë‹ˆë‹¤.</p>

<p>ë³‘ë ¬ ê³„ì‚°ì€, íŠ¹ì • ìœ í˜•ì˜ í”„ë¡œê·¸ë˜ë° ì‘ì—…ì„ í›¨ì”¬ ë” ë¹ ë¥´ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ( ë‹¨, ì»´í“¨íŒ… ì„±ëŠ¥ì´ í–¥ìƒë˜ë©´ ë³µì¡ì„±ë„ ì»¤ì§‘ë‹ˆë‹¤. )</p>

<p>Sparkê°€ í•´ë‹¹ ë¬¸ì œì— ëŒ€í•œ ìµœìƒì˜ ì†”ë£¨ì…˜ ì—¬ë¶€ë¥¼ ê²°ì • í•˜ëŠ” ë°ëŠ” ê²½í—˜ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<ul>
  <li>ë°ì´í„°ê°€ ë„ˆë¬´ ì»¤ì„œ, ë‹¨ì¼í™” ì‹œìŠ¤í…œì—ì„œ ì‘ì—… í•  ìˆ˜ ì—†ë‹¤.</li>
  <li>ê³„ì‚°ì„ ì‰½ê²Œ ë³‘ë ¬í™” í•  ìˆ˜ ìˆë‹¤.</li>
</ul>

<p><br /></p>

<h4 id="using-spark-in-python">Using Spark in Python</h4>

<p>Spark ì‚¬ìš©ì˜ ì²«ë²ˆì§¸ëŠ”, í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>í´ëŸ¬ìŠ¤í„°ëŠ” ë‹¤ë¥¸ ëª¨ë“  ë…¸ë“œì— ì—°ê²°ëœ ì›ê²© ì‹œìŠ¤í…œì—ì„œ í˜¸ìŠ¤íŒ… ë©ë‹ˆë‹¤. ë°ì´í„°ì™€ ê³„ì‚° ë¶„í• ì„ ê´€ë¦¬í•˜ëŠ” ì»´í“¨í„°ë¥¼ <strong>ë§ˆìŠ¤í„°(master)</strong> ë¼ê³  í•˜ë©°, ë§ˆìŠ¤í„°ëŠ” <strong>ì‘ì—…ì(worker)</strong> ë¼ê³  í•˜ëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ë‚˜ë¨¸ì§€ ì»´í“¨í„°ì™€ ì—°ê²°ë©ë‹ˆë‹¤.</p>

<p>ë§ˆìŠ¤í„°ëŠ” ì‘ì—…ìì—ê²Œ ë°ì´í„°ì™€ ê³„ì‚°ì„ ì‹¤í–‰í•˜ë„ë¡ ë³´ë‚´ê³ , ì‘ì—…ìëŠ” ê²°ê³¼ë¥¼ ë‹¤ì‹œ ë§ˆìŠ¤í„°ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</p>

<p>í•´ë‹¹ ì—°ê²°ì„ ë§Œë“œëŠ” ë°©ë²•ì€ <code class="language-plaintext highlighter-rouge">SparkContext</code> í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>í´ë˜ìŠ¤ ìƒì„±ìëŠ” ì—°ê²°í•˜ë ¤ëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ì†ì„±ì„ ì§€ì •í•  ìˆ˜ ìˆëŠ” ëª‡ê°€ì§€ ì¸ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>ëª¨ë“  ì†ì„±ì„ í¬í•¨í•˜ëŠ” ê°œì²´ëŠ” <code class="language-plaintext highlighter-rouge">SparkConf()</code>ìƒì„±ìë¥¼ ì‚¬ìš©í•˜ì—¬ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h4 id="examining-the-sparkcontext">Examining The SparkContext</h4>

<p>SparkëŠ” serious softwareì…ë‹ˆë‹¤. ì´ê²ƒì€ ì‚¬ìš©í•˜ëŠ” ê²ƒë³´ë‹¤, ì‹œì‘í•˜ëŠ”ë° ì‹œê°„ì„ ë” ë§ì´ ì†Œìš”í•©ë‹ˆë‹¤.</p>

<p>ê°„ë‹¨í•œ í”„ë¡œê·¸ë¨ì€, ìŠ¤íŒŒí¬ë³´ë‹¤, ë‹¤ë¥¸ ê²ƒì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì¼ ê²ƒ ì…ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Verify SparkContext
</span><span class="k">print</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="c1"># Print Spark version
</span><span class="k">print</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="examining-the-sparkcontext-1">Examining The SparkContext</h4>

<p>SparkëŠ” ì‹œì‘í•˜ëŠ”ë° ë§ì€ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤. ë˜í•œ ê°„ë‹¨í•œ ê³„ì‚°ì„ ì‹¤í–‰í•˜ëŠ” ë° ì˜¤ë˜ ê±¸ë¦´ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>SparkëŠ” ë¹…ë°ì´í„°ì™€ ê°™ì´ ë³µì¡í•œ ì‘ì—…ì„ ìœ„í•´ ì„¤ê³„ë˜ì–´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ( ì‘ì€ ì‘ì—…ì„ í•  ë•ŒëŠ”, Sparkê°€ íš¨ìœ¨ì ì´ì§€ ì•Šë‹¤. )</p>

<p><br /></p>

<h4 id="using-dataframes">Using DataFrames</h4>

<p>Sparkì˜ í•µì‹¬ ë°ì´í„° êµ¬ì¡°ëŠ” RDD(Resilient Distributed Dataset) ì…ë‹ˆë‹¤. ì´ê²ƒì€ í´ëŸ¬ìŠ¤íŠ¸ì˜ ì—¬ëŸ¬ ë…¸ë“œì— ë°ì´í„°ë¥¼ ë¶„í• í•˜ì—¬ Sparkê°€ ë§ˆë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ì €ìˆ˜ì¤€ì˜ ê°œì²´ì´ì§€ë§Œ, RDDëŠ” ì§ì ‘ ì‘ì—…í•˜ê¸° ì–´ë µê¸°ë•Œë¬¸ì—, RDD ìœ„ì— êµ¬ì¶•ëœ Spark DataFrame ì¶”ìƒí™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>Spark DataFrameì€ SQL í…Œì´ë¸”ê³¼ ë§¤ìš° ìœ ì‚¬í•˜ê²Œ ì„¤ê³„ë˜ì–´ìˆìŠµë‹ˆë‹¤. DataFrame ì€ ì´í•´í•˜ê¸° ì‰¬ìš¸ ë¿ë§Œ ì•„ë‹ˆë¼ RDDë³´ë‹¤ ë³µì¡í•œ ì‘ì—…ì— ë” ìµœì í™” ë˜ì–´ìˆìŠµë‹ˆë‹¤.</p>

<p><br /></p>

<p>RDDë¥¼ ì‚¬ìš©í•  ë•Œ, ì¿¼ë¦¬ë¥¼ ìµœì í™”í•˜ëŠ” ì˜¬ë°”ë¥¸ ë°©ë²•ì„ íŒŒì•…í•˜ëŠ” ê²ƒì€, ë°ì´í„° ê³¼í•™ìì—ê²Œ ìˆì§€ë§Œ, DataFrame êµ¬ì—ëŠ” ìµœì í™” ë¶€ë¶„ì´ ë‚´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<p>Sparkì˜ DataFrameì‘ì—…ì„ ì‹œì‘í•˜ë©´, <code class="language-plaintext highlighter-rouge">SparkSession</code> ì„ ë§Œë“¤ê³ , <code class="language-plaintext highlighter-rouge">SparkContext</code>, <code class="language-plaintext highlighter-rouge">SparkContext</code> í´ëŸ¬ìŠ¤í„°ì— <code class="language-plaintext highlighter-rouge">SparkSession</code> ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.</p>

<p><br /></p>

<h4 id="creating-a-sparksession">Creating a SparkSession</h4>

<p><code class="language-plaintext highlighter-rouge">Sparksession</code> ì€ <code class="language-plaintext highlighter-rouge">spark</code>ë¼ê³  ë¶ˆë¦¬ëŠ” ê²ƒì„ í†µí•´, ìƒì„±í•©ë‹ˆë‹¤.</p>

<p>í•˜ì§€ë§Œ, <code class="language-plaintext highlighter-rouge">SparkSession</code> ì™€, <code class="language-plaintext highlighter-rouge">SparkContext</code>ë¥¼ ì—¬ëŸ¬ê°œ ìƒì„±í•˜ë©´ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">SparkSession.builder.getOrCreate()</code> ë¥¼ í†µí•´ ìƒì„±í•˜ëŠ” ê²ƒì´ ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import SparkSession from pyspark.sql
</span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="c1"># Create my_spark
</span><span class="n">my_spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="c1"># Print my_spark
</span><span class="k">print</span><span class="p">(</span><span class="n">my_spark</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="viewing-tables">Viewing tables</h4>

<p><code class="language-plaintext highlighter-rouge">SparkSession</code> ì€, <code class="language-plaintext highlighter-rouge">catalog</code> ë¼ê³  ë¶ˆë¦¬ëŠ” íŠ¹ì„±ì„ ê°€ì§‘ë‹ˆë‹¤. ê·¸ ì¤‘ ìœ ìš©í•œ, <code class="language-plaintext highlighter-rouge">.listTables()</code>ë¥¼ ì‚¬ìš©í•˜ë©´, í•´ë‹¹ í…Œì´ë¸”ì˜ ì´ë¦„ì„ ë°˜í™˜í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Print the tables in the catalog
</span><span class="k">print</span><span class="p">(</span><span class="n">spark</span><span class="p">.</span><span class="n">catalog</span><span class="p">.</span><span class="n">listTables</span><span class="p">())</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="are-you-query-ious">Are you query-ious?</h4>

<p>Sparkì˜ ì´ì  ì¤‘ í•˜ë‚˜ì¸, DataFrame InterfaceëŠ” SQL ì¿¼ë¦¬ë¥¼ Spark clusterì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Don't change this query
</span><span class="n">query</span> <span class="o">=</span> <span class="s">"FROM flights SELECT * LIMIT 10"</span>

<span class="c1"># Get the first 10 rows of flights
</span><span class="n">flights10</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># Show the results
</span><span class="n">flights10</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="pandafy-a-spark-dataframe">Pandafy a Spark DataFrame</h4>

<p>Spark DataFrameì„ pandasë¡œ ë§Œë“œëŠ” ë°©ë²•ë„ ìˆìŠµë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">.toPandas()</code> ì´ìš©</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Don't change this query
</span><span class="n">query</span> <span class="o">=</span> <span class="s">"SELECT origin, dest, COUNT(*) as N FROM flights GROUP BY origin, dest"</span>

<span class="c1"># Run the query
</span><span class="n">flight_counts</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># Convert the results to a pandas DataFrame
</span><span class="n">pd_counts</span> <span class="o">=</span> <span class="n">flight_counts</span><span class="p">.</span><span class="n">toPandas</span><span class="p">()</span>

<span class="c1"># Print the head of pd_counts
</span><span class="k">print</span><span class="p">(</span><span class="n">pd_counts</span><span class="p">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="put-some-spark-in-your-data">Put some Spark in your data</h4>

<p>ì´ì „ê³¼ ë‹¬ë¦¬, pandas DataFrameì„ spark DataFrameìœ¼ë¡œ ë§Œë“œëŠ” ë²• ë˜í•œ ë‹¹ì—°íˆ ì¡´ì¬í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create pd_temp
</span><span class="n">pd_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Create spark_temp from pd_temp
</span><span class="n">spark_temp</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">pd_temp</span><span class="p">)</span>

<span class="c1"># Examine the tables in the catalog
</span><span class="k">print</span><span class="p">(</span><span class="n">spark</span><span class="p">.</span><span class="n">catalog</span><span class="p">.</span><span class="n">listTables</span><span class="p">())</span>

<span class="c1"># Add spark_temp to the catalog
</span><span class="n">spark_temp</span><span class="p">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s">"temp"</span><span class="p">)</span>

<span class="c1"># Examine the tables in the catalog again
</span><span class="k">print</span><span class="p">(</span><span class="n">spark_temp</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="dropping-the-middle-man">Dropping the middle man</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Don't change this file path
</span><span class="n">file_path</span> <span class="o">=</span> <span class="s">"/usr/local/share/datasets/airports.csv"</span>

<span class="c1"># Read in the airports data
</span><span class="n">airports</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Show the data
</span><span class="n">airports</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="2-manipulating-data">2. Manipulating data</h2>

<p><br /></p>

<h4 id="creating-columns">Creating columns</h4>

<p><code class="language-plaintext highlighter-rouge">.withColumn()</code>  2ê°œì˜ arguments í•„ìš”ë¡œí•˜ë©°, ìƒˆë¡œìš´ columnì´ë¦„ê³¼, ë°ì´í„°ë¥¼ í•„ìš”ë¡œí•©ë‹ˆë‹¤. ìƒˆë¡œìš´ columnì€ ê°ì²´ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.</p>

<p>ì˜ˆì‹œ:  <code class="language-plaintext highlighter-rouge">df = df.withColumn("newCol", df.oldCol + 1)</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create the DataFrame flights
</span><span class="n">flights</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s">"flights"</span><span class="p">)</span>

<span class="c1"># Show the head
</span><span class="n">flights</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Add duration_hrs
</span><span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"duration_hrs"</span><span class="p">,</span> <span class="n">flights</span><span class="p">.</span><span class="n">air_time</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="sql-in-a-nutshell">SQL in a nutshell</h4>

<p>SQL ì¿¼ë¦¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— í¬í•¨ëœ í•˜ë‚˜ ì´ìƒì˜ í…Œì´ë¸”ì—ì„œ íŒŒìƒëœ í…Œì´ë¸”ì„ ë°˜í™˜í•©ë‹ˆë‹¤.</p>

<p>ëª¨ë“  SQL ì¿¼ë¦¬ëŠ” ë°ì´í„° ë² ì´ìŠ¤ì— ë°ì´í„°ë¡œ ìˆ˜í–‰í•˜ë ¤ëŠ” ì‘ì—…ì„ ì•Œë ¤ì£¼ëŠ” ëª…ë ¹ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">my_table</span><span class="p">;</span>
</code></pre></div></div>

<p>ë‹¤ìŒê³¼ ê°™ì´ ì—°ì‚°ì„ í•  ìˆ˜ ë„ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">air_time</span> <span class="o">/</span> <span class="mi">60</span> <span class="k">FROM</span> <span class="n">flights</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">students</span>
<span class="k">WHERE</span> <span class="n">grade</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="sql-in-a-nutshell-2">SQL in a nutshell (2)</h4>

<p>ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì§‘ê³„í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì€, ë°ì´í„° ì–‘ì„ ì¤„ì´ëŠ”ë° íš¨ê³¼ì ì…ë‹ˆë‹¤. ì´ëŠ” SQLì—ì„œ <code class="language-plaintext highlighter-rouge">GROUP BY</code> ë¥¼ í†µí•´ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">flights</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">origin</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">flights</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dest</span><span class="p">;</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="filtering-data">Filtering Data</h4>

<p>SQLì—ì„œ whereë¥¼ ì‚¬ìš©í–ˆë˜ ê²ƒì²˜ëŸ¼, DataFrameì—ì„œ <code class="language-plaintext highlighter-rouge">.filter</code> ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ë„ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="s">"air_time &gt; 120"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>
<span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">air_time</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>SQLì—ì„œëŠ” ë‹¤ìŒì˜ ì½”ë“œë¡œ ë™ì‘í–ˆì„ ê²ƒì…ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">flights</span> <span class="k">WHERE</span> <span class="n">air_time</span> <span class="o">&gt;</span> <span class="mi">120</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Filter flights by passing a string
</span><span class="n">long_flights1</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="s">"distance &gt; 1000"</span><span class="p">)</span>

<span class="c1"># Filter flights by passing a column of boolean values
</span><span class="n">long_flights2</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">distance</span>  <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Print the data to check they're equal
</span><span class="n">long_flights1</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">long_flights2</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="selecting">Selecting</h4>

<p>Sparkì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">SELECT</code> ë¥¼ <code class="language-plaintext highlighter-rouge">.select()</code> ë¥¼ í†µí•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">withColumn()</code> ê³¼ì˜ ì°¨ì´ì ì€, <code class="language-plaintext highlighter-rouge">select()</code> ì€ ì§€ì •í•œ ì—´ë§Œ ë°˜í™˜í•˜ì§€ë§Œ, <code class="language-plaintext highlighter-rouge">withColumn()</code> ì€ ëª¨ë“  DataFrame ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select the first set of columns
</span><span class="n">selected1</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"tailnum"</span><span class="p">,</span> <span class="s">"origin"</span><span class="p">,</span> <span class="s">"dest"</span><span class="p">)</span>

<span class="c1"># Select the second set of columns
</span><span class="n">temp</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">flights</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">flights</span><span class="p">.</span><span class="n">carrier</span><span class="p">)</span>

<span class="c1"># Define first filter
</span><span class="n">filterA</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s">"SEA"</span>

<span class="c1"># Define second filter
</span><span class="n">filterB</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">dest</span> <span class="o">==</span> <span class="s">"PDX"</span>

<span class="c1"># Filter the data, first by filterA then by filterB
</span><span class="n">selected2</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">filterA</span><span class="p">).</span><span class="nb">filter</span><span class="p">(</span><span class="n">filterB</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="selecting-ii">Selecting II</h4>

<p><code class="language-plaintext highlighter-rouge">.select()</code> ì•ˆì—ì„œ ì—°ì‚°ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">flights.select(flights.air_time/60)</code></p>

<p><code class="language-plaintext highlighter-rouge">.alias()</code> ë¥¼ í†µí•´ SQLì—ì„œ <code class="language-plaintext highlighter-rouge">as</code>ì²˜ëŸ¼ ì‚¬ìš©ë˜ë˜ ê²ƒì„ êµ¬í˜„í•  ìˆ˜ ë„ ìˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">flights.select((flights.air_time/60).alias("duration_hrs"))</code></p>

<p>í˜¹ì¸ <code class="language-plaintext highlighter-rouge">.selectExpr()</code> ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">flights.selectExpr("air_time/60 as duration_hrs")</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define avg_speed
</span><span class="n">avg_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">distance</span><span class="o">/</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">air_time</span><span class="o">/</span><span class="mi">60</span><span class="p">)).</span><span class="n">alias</span><span class="p">(</span><span class="s">"avg_speed"</span><span class="p">)</span>

<span class="c1"># Select the correct columns
</span><span class="n">speed1</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"origin"</span><span class="p">,</span> <span class="s">"dest"</span><span class="p">,</span> <span class="s">"tailnum"</span><span class="p">,</span> <span class="n">avg_speed</span><span class="p">)</span>

<span class="c1"># Create the same table using a SQL expression
</span><span class="n">speed2</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s">"origin"</span><span class="p">,</span> <span class="s">"dest"</span><span class="p">,</span> <span class="s">"tailnum"</span><span class="p">,</span> <span class="s">"distance/(air_time/60) as avg_speed"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="aggregating">Aggregating</h3>

<p><code class="language-plaintext highlighter-rouge">.groupBy()</code> ë¥¼ í†µí•´, <code class="language-plaintext highlighter-rouge">.min()</code>,  <code class="language-plaintext highlighter-rouge">.max()</code>,  <code class="language-plaintext highlighter-rouge">.count()</code>ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">df.groupBy().min("col").show()</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find the shortest flight from PDX in terms of distance
</span><span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s">"PDX"</span><span class="p">).</span><span class="n">groupBy</span><span class="p">().</span><span class="nb">min</span><span class="p">(</span><span class="s">"distance"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Find the longest flight from SEA in terms of air time
</span><span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s">"SEA"</span><span class="p">).</span><span class="n">groupBy</span><span class="p">().</span><span class="nb">max</span><span class="p">(</span><span class="s">"air_time"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="aggregating-ii">Aggregating II</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Average duration of Delta flights
</span><span class="n">flights</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">carrier</span> <span class="o">==</span> <span class="s">"DL"</span><span class="p">).</span><span class="nb">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s">"SEA"</span><span class="p">).</span><span class="n">groupBy</span><span class="p">().</span><span class="n">avg</span><span class="p">(</span><span class="s">"air_time"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Total hours in the air
</span><span class="n">flights</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"duration_hrs"</span><span class="p">,</span> <span class="n">flights</span><span class="p">.</span><span class="n">air_time</span><span class="o">/</span><span class="mi">60</span><span class="p">).</span><span class="n">groupBy</span><span class="p">().</span><span class="nb">sum</span><span class="p">(</span><span class="s">"duration_hrs"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="grouping-and-aggregating-i">Grouping and Aggregating I</h4>

<p><code class="language-plaintext highlighter-rouge">groupBy()</code> ë’¤, sum, count ë“±ì„ ì¶”ê°€í•˜ì§€ì•Šìœ¼ë©´, ë‹¤ìŒ ì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Group by tailnum
</span><span class="n">by_plane</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s">"tailnum"</span><span class="p">)</span>

<span class="c1"># Number of flights each plane made
</span><span class="n">by_plane</span><span class="p">.</span><span class="n">count</span><span class="p">().</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Group by origin
</span><span class="n">by_origin</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s">"origin"</span><span class="p">)</span>

<span class="c1"># Average duration of flights from PDX and SEA
</span><span class="n">by_origin</span><span class="p">.</span><span class="n">avg</span><span class="p">(</span><span class="s">"air_time"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="grouping-and-aggregating-ii">Grouping and Aggregating II</h4>

<p><code class="language-plaintext highlighter-rouge">groupBy</code> ë¿ë§Œ ì•„ë‹ˆë¼, <code class="language-plaintext highlighter-rouge">.agg()</code> ë„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">.agg()</code> ë©”ì†Œë“œëŠ” <code class="language-plaintext highlighter-rouge">pyspark.sql.functions</code> ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import pyspark.sql.functions as F
</span><span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="n">F</span>

<span class="c1"># Group by month and dest
</span><span class="n">by_month_dest</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s">"month"</span><span class="p">,</span> <span class="s">"dest"</span><span class="p">)</span>

<span class="c1"># Average departure delay by month and destination
</span><span class="n">by_month_dest</span><span class="p">.</span><span class="n">avg</span><span class="p">(</span><span class="s">"dep_delay"</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Standard deviation of departure delay
</span><span class="n">by_month_dest</span><span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">stddev</span><span class="p">(</span><span class="s">"dep_delay"</span><span class="p">)).</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="joining">Joining</h4>

<p>Joiningì€ ë§ì´ ì‚¬ìš©ë˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.</p>

<p>ì¡°ì¸ì€ ë‹¤ë¥¸ 2ê°œì˜ í…Œì´ë¸”ì„ ê²°í•©ì‹œí‚¤ê²Œ ë©ë‹ˆë‹¤.</p>

<p>PySparkì—ì„œëŠ” DataFrame í•¨ìˆ˜ë¡œ, <code class="language-plaintext highlighter-rouge">.join()</code> ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì„¸ê°œì˜ ì¸ìê°€ ìˆëŠ”ë°, ê²°í•©í•˜ê³ ì í•˜ëŠ” í…Œì´ë¸”, on, how ì…ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">on</code> ì€, ì–´ë–¤ ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ joiní•˜ëŠ”ì§€ë¥¼, <code class="language-plaintext highlighter-rouge">how</code>ëŠ” leftouter ë“± ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ join í•˜ëŠ”ì§€ë¥¼ ì„ íƒí•˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># Examine the data
</span> <span class="k">print</span><span class="p">(</span><span class="n">airports</span><span class="p">.</span><span class="n">show</span><span class="p">())</span>
 
 <span class="c1"># Rename the faa column
</span> <span class="n">airports</span> <span class="o">=</span> <span class="n">airports</span><span class="p">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s">"faa"</span><span class="p">,</span> <span class="s">"dest"</span><span class="p">)</span>
 
 <span class="c1"># Join the DataFrames
</span> <span class="n">flights_with_airports</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">airports</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"dest"</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">"leftouter"</span><span class="p">)</span>
 
 <span class="c1"># Examine the new DataFrame
</span> <span class="k">print</span><span class="p">(</span><span class="n">flights_with_airports</span><span class="p">.</span><span class="n">show</span><span class="p">())</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="3-getting-started-with-machine-learning-pipelines">3. Getting started with machine learning pipelines</h2>

<p><br /></p>

<h4 id="machine-learning-pipelines">Machine Learning Pipelines</h4>

<p><code class="language-plaintext highlighter-rouge">pyspark.ml</code> ì˜ ì¤‘ì‹¬ì€, <code class="language-plaintext highlighter-rouge">Transformer</code> ì™€ <code class="language-plaintext highlighter-rouge">Estimator</code> í´ë˜ìŠ¤ì…ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">Transformer</code> í´ë˜ìŠ¤ëŠ”, <code class="language-plaintext highlighter-rouge">.transformer()</code> í•¨ìˆ˜ë¥¼ í†µí•´ì„œ, DataFrameì„ ë³€í™˜í•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">Bucketizer</code>ë¥¼ ì´ìš©í•˜ì—¬, ì—°ì†ëœ í”¼ì²˜ í˜¹ì€ í´ë˜ìŠ¤ë¡œ ë¶€í„°, discrete binsì„ ë§Œë“¤ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">PCA</code>ë¥¼ í†µí•´ ë°ì´í„°ì…‹ì˜ ì£¼ì„±ë¶„ ë¶„ì„ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">Estimator</code>í´ë˜ìŠ¤ëŠ”, <code class="language-plaintext highlighter-rouge">.fit()</code>ë¥¼ í†µí•´ ì‹¤í–‰ë©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">StringIndexerModel</code> í˜¹ì€ <code class="language-plaintext highlighter-rouge">RandomForestModel</code> ì´ ì´ê²ƒì— í•´ë‹¹ë©ë‹ˆë‹¤.</p>

<p><br /></p>

<h4 id="join-the-dataframes">Join the DataFrames</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Rename year column
</span><span class="n">planes</span> <span class="o">=</span> <span class="n">planes</span><span class="p">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s">"year"</span><span class="p">,</span><span class="s">"plane_year"</span><span class="p">)</span>

<span class="c1"># Join the DataFrames
</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">flights</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"tailnum"</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">"leftouter"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="data-types">Data types</h4>

<p>SparkëŠ” numeric ë°ì´í„°ë§Œ, í•¸ë“¤ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ìš°ë¦¬ê°€ ë°ì´í„°ë¥¼ ì„ ì–¸í•˜ë©´, SparkëŠ” í•´ë‹¹ ë°ì´í„°ì— ëŒ€í•œ ì •ë³´ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤. ë¶ˆí–‰íˆë„ í•­ìƒ ì˜³ë°”ë¥´ê²Œ íŒë‹¨í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. DataFrameì˜ ì¼ë¶€ ì—´ì€, ì‹¤ì œ ìˆ«ì ê°’ì´ ì•„ë‹Œ, ìˆ«ìê°€ í‡ë§ˆëœ ë¬¸ìì—´ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ <code class="language-plaintext highlighter-rouge">.withColumn()</code> ì™€ í•¨ê»˜<code class="language-plaintext highlighter-rouge">.cast()</code>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">.cast()</code> ëŠ” ì¸ìë¡œ í•˜ë‚˜ë§Œ ì…ë ¥ ë°›ëŠ”ë°, ì •ìˆ˜ì¼ê²½ìš° â€œintegerâ€ë¥¼ decimal numbersì¸ ê²½ìš° â€œdoubleâ€ì„ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<p><br /></p>

<h4 id="string-to-integer">String to integer</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"col"</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">.</span><span class="n">col</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s">"new_type"</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Cast the columns to integers
</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"arr_delay"</span><span class="p">,</span> <span class="n">model_data</span><span class="p">.</span><span class="n">arr_delay</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s">"integer"</span><span class="p">))</span>
<span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"air_time"</span><span class="p">,</span> <span class="n">model_data</span><span class="p">.</span><span class="n">air_time</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s">"integer"</span><span class="p">))</span>
<span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"month"</span><span class="p">,</span> <span class="n">model_data</span><span class="p">.</span><span class="n">month</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s">"integer"</span><span class="p">))</span>
<span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"plane_year"</span><span class="p">,</span>  <span class="n">model_data</span><span class="p">.</span><span class="n">plane_year</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s">"integer"</span><span class="p">))</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="create-a-new-column">Create a new column</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create the column plane_age
</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"plane_age"</span><span class="p">,</span> <span class="n">model_data</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">model_data</span><span class="p">.</span><span class="n">plane_year</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="making-a-boolean">Making a Boolean</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create is_late
</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"is_late"</span><span class="p">,</span> <span class="n">model_data</span><span class="p">.</span><span class="n">arr_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Convert to an integer
</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"label"</span><span class="p">,</span> <span class="n">model_data</span><span class="p">.</span><span class="n">is_late</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s">"integer"</span><span class="p">))</span>

<span class="c1"># Remove missing values
</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="s">"arr_delay is not NULL and dep_delay is not NULL and air_time is not NULL and plane_year is not NULL"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="strings-and-factors">Strings and factors</h4>

<p>ëª¨ë¸ë§ì„ ìœ„í•´ì„ , ìˆ«ìí˜• ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ, Stringì„ ìˆ«ìí˜• ë°ì´í„°ë¡œ ë³€í™˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p>Pysparkì—ì„œëŠ”, <code class="language-plaintext highlighter-rouge">pyspark.ml.feature</code> í•˜ìœ„ ëª¨ë“ˆì— ì´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì´ ë‚´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” one-hot-vectorë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ì„ ì´ìš©í•©ë‹ˆë‹¤.</p>

<p>ë¨¼ì € <code class="language-plaintext highlighter-rouge">StringIndexer</code>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ í´ë˜ìŠ¤ì´ ë©¤ë²„ëŠ” <code class="language-plaintext highlighter-rouge">Estimator</code>ë¬¸ìì—´ ì—´ì´ ìˆëŠ” DataFrameì˜ ê³ ìœ  ë¬¸ìì—´ë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³ , <code class="language-plaintext highlighter-rouge">Estimator</code>ëŠ” ë§¤í•‘ëœ ë©”íƒ€ë°ì´í„°ë¥¼ í¬í•¨í•œ DataFrameì˜ <code class="language-plaintext highlighter-rouge">Transformer</code>ë¥¼ ë¦¬í„´í•©ë‹ˆë‹¤. ë˜í•œ, ë¬¸ìì—´ ì»¬ëŸ¼ê³¼ ê´€ë ¨ìˆëŠ” ìˆ«ìí˜• ì»¬ëŸ¼ë„ ë¦¬í„´í•©ë‹ˆë‹¤.</p>

<p>ë‘ë²ˆ ì§¸ ë‹¨ê³„ëŠ”, ì´ ì»¬ëŸ¼ì„ <code class="language-plaintext highlighter-rouge">OneHotEncoder</code>ë¥¼ ì´ìš©í•˜ì—¬ ì¸ì½”ë“œí•©ë‹ˆë‹¤.</p>

<p><br /></p>

<h4 id="carrier">Carrier</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a StringIndexer
</span><span class="n">carr_indexer</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s">"carrier"</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s">"carrier_index"</span><span class="p">)</span>

<span class="c1"># Create a OneHotEncoder
</span><span class="n">carr_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s">"carrier_index"</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s">"carrier_fact"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="destination">Destination</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a StringIndexer
</span><span class="n">dest_indexer</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s">"dest"</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s">"dest_index"</span><span class="p">)</span>

<span class="c1"># Create a OneHotEncoder
</span><span class="n">dest_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s">"dest_index"</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s">"dest_fact"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="assemble-a-vector">Assemble a vector</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make a VectorAssembler
</span><span class="n">vec_assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s">"month"</span><span class="p">,</span> <span class="s">"air_time"</span><span class="p">,</span> <span class="s">"carrier_fact"</span><span class="p">,</span> <span class="s">"dest_fact"</span><span class="p">,</span> <span class="s">"plane_age"</span><span class="p">],</span> <span class="n">outputCol</span><span class="o">=</span><span class="s">"features"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="create-the-pipeline">Create the pipeline</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import Pipeline
</span><span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Make the pipeline
</span><span class="n">flights_pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">dest_indexer</span><span class="p">,</span> <span class="n">dest_encoder</span><span class="p">,</span> <span class="n">carr_indexer</span><span class="p">,</span> <span class="n">carr_encoder</span><span class="p">,</span> <span class="n">vec_assembler</span><span class="p">])</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="test-vs-train">Test vs Train</h4>

<p>ëª¨ë¸ë§ì„ ìœ„í•´ì„œ ì¤‘ìš”í•œ ê²ƒ ì¤‘ í•˜ë‚˜ëŠ”, ë°ì´í„°ë¥¼ ë‚˜ëˆ„ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>Sparkì—ì„œëŠ” ëª¨ë“  ë³€í™˜ í›„ì— ë°ì´í„°ë¥¼ ë¶„í• í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fit and transform the data
</span><span class="n">piped_data</span> <span class="o">=</span> <span class="n">flights_pipe</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model_data</span><span class="p">).</span><span class="n">transform</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Split the data into training and test sets
</span><span class="n">training</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">piped_data</span><span class="p">.</span><span class="n">randomSplit</span><span class="p">([.</span><span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="mi">4</span><span class="p">])</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="4-model-tuning-and-selection">4. Model tuning and selection</h2>

<p><br /></p>

<h4 id="create-the-modeler">Create the modeler</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import LogisticRegression
</span><span class="kn">from</span> <span class="nn">pyspark.ml.classification</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="c1"># Create a LogisticRegression Estimator
</span><span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="cross-validation">Cross validation</h4>

<p>í›ˆë ¨ ë°ì´í„°ë¥¼ ëª‡ ê°œì˜ ë‹¤ë¥¸ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„í• í•˜ì—¬ ì‘ë™í•©ë‹ˆë‹¤.</p>

<p>ë°ì´í„°ê°€ ë¶„í• ë˜ë©´, íŒŒí‹°ì…˜ ì¤‘ í•˜ë‚˜ê°€ ë”°ë¡œ ì„¤ì •ë˜ë©° ëª¨ë¸ì´ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì— ì‘ë™í•˜ê³ , ë³´ë¥˜ëœ íŒŒí‹°ì…˜ì— ëŒ€í•´ lossë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.</p>

<p>ì´ê²ƒì€ ê° íŒŒí‹°ì…˜ì— ëŒ€í•´ ë°˜ë³µë˜ë©° ê° íŒŒí‹°ì…˜ì˜ lossê°’ì˜ í‰ê· ì„ ì¶œë ¥í•©ë‹ˆë‹¤.</p>

<p>ì´ë¥¼ êµì°¨ ê²€ì¦ ë¡œê·œì•–ì´ë¼ê³  í•˜ë©° ì‹¤ì œ ì˜¤ë¥˜ì— ëŒ€í•œ ì¢‹ì€ ì¶”ì •ì¹˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">pyspark.ml.evaluation</code> ë¥¼ í†µí•´ì„œ ê°’ì„ í‰ê°€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the evaluation submodule
</span><span class="kn">import</span> <span class="nn">pyspark.ml.evaluation</span> <span class="k">as</span> <span class="n">evals</span>

<span class="c1"># Create a BinaryClassificationEvaluator
</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">evals</span><span class="p">.</span><span class="n">BinaryClassificationEvaluator</span><span class="p">(</span><span class="n">metricName</span><span class="o">=</span><span class="s">"areaUnderROC"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="make-a-grid">Make a grid</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the tuning submodule
</span><span class="kn">import</span> <span class="nn">pyspark.ml.tuning</span> <span class="k">as</span> <span class="n">tune</span>

<span class="c1"># Create the parameter grid
</span><span class="n">grid</span> <span class="o">=</span> <span class="n">tune</span><span class="p">.</span><span class="n">ParamGridBuilder</span><span class="p">()</span>

<span class="c1"># Add the hyperparameter
</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="p">.</span><span class="n">addGrid</span><span class="p">(</span><span class="n">lr</span><span class="p">.</span><span class="n">regParam</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="mi">01</span><span class="p">))</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="p">.</span><span class="n">addGrid</span><span class="p">(</span><span class="n">lr</span><span class="p">.</span><span class="n">elasticNetParam</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Build the grid
</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="make-the-validator">Make the validator</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create the CrossValidator
</span><span class="n">cv</span> <span class="o">=</span> <span class="n">tune</span><span class="p">.</span><span class="n">CrossValidator</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
               <span class="n">estimatorParamMaps</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
               <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span>
               <span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="fit-the-models">Fit the model(s)</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Call lr.fit()
</span><span class="n">best_lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>

<span class="c1"># Print best_lr
</span><span class="k">print</span><span class="p">(</span><span class="n">best_lr</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="evaluate-the-model">Evaluate the model</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Use the model to predict the test set
</span><span class="n">test_results</span> <span class="o">=</span> <span class="n">best_lr</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="c1"># Evaluate the predictions
</span><span class="k">print</span><span class="p">(</span><span class="n">evaluator</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_results</span><span class="p">))</span>
</code></pre></div></div>

:ET